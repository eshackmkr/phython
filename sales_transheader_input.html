<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{#  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">#}
  <script src="https://kit.fontawesome.com/766d8c76a8.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="C:\Users\ESHACK.TOSHIBA-HOME\Dropbox\My Phythan lessons\style.css">


</head>
<body>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <!-- Brand -->
  <a class="navbar-brand" href="#">Logo</a>

  <!-- Links -->
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" href="">Book Store</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="">Sales</a>
    </li>
      <li class="nav-item">
      <a class="nav-link" href="#">Purchase</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="">Stock Report</a>
    </li>
    <!-- Dropdown -->
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
        Dropdown link
      </a>
      <div class="dropdown-menu">
        <a class="dropdown-item" href="#">Link 1</a>
        <a class="dropdown-item" href="#">Link 2</a>
        <a class="dropdown-item" href="#">Link 3</a>
      </div>
    </li>
  </ul>
</nav>
<!-- Sidebar -->
<div class="w3-sidebar w3-bar-block w3-border-right" style="display:none" id="mySidebar">
  <button onclick="w3_close()" class="w3-bar-item w3-large">Close &times;</button>
  <a href="#" class="w3-bar-item w3-button">Link 1</a>
  <a href="#" class="w3-bar-item w3-button">Link 2</a>
  <a href="#" class="w3-bar-item w3-button">Link 3</a>
</div>

<!-- Page Content -->
<div class="w3-teal">
<div class="element1">
  <button class="w3-button w3-teal w3-xlarge" onclick="w3_open()">â˜°</button>
</div>
<div class="element2">
    <h5>Western Matriculation School</h5>

</div>
</div>
<div class="w3-container">

<form action="" method="post" class="w-auto" id="new_trans_form" xmlns:width="http://www.w3.org/1999/xhtml">
    <div class="row mt-3 mb-5" >
        <div class="col-md-12">
            <div>
                <div class="headerctr">
                 s     <div>
                    <!-- <h3 > -->
                        Sales Transaction Header
                    <!-- </h3> -->
                </div>
                <div class="card-body">

                    
                    <div 38rem class="row style= width:18">
                        <div class="col">
                            <label>Transaction Date</label>
                            <input type="date" class="form-control" name="{{form.th_dt.name}}" value="{{current_date}}"
                                readonly>
                           
                        </div>
                        <div class="col-sm" >
                            <label>Transaction Number</label>
                            <input type="number" class="form-control" name="{{form.th_no.name}}"
                                value="{{transaction_number}}" readonly>
                           
                        </div>
                        <div class="col">
                         <!-- <label>Transaction Type</label>
                            <input type="hidden" class="form-control" name="{{form.th_type.name}}" required readonly
                                value="INV"> -->
                         

                            <label>Transaction Ref.</label>
                            <input type="text" class="form-control" name="{{form.th_ref.name}}" required
                                value="nil">
                            
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col">
                            <label>Transaction Code</label>
                            <input type="text" class="form-control" name="{{form.th_code.name}}" required readonly
                                value="POS INV">
                            
                        </div>
                        <div class="col">
                            <label>Transaction Customer Code</label>
                            <input type="text" class="form-control" name="{{form.th_cust_code.name}}" required
                                value="A001">
                            
                        </div>
                        <div class="col">
                            <label>Transaction Salesman</label>
                            <input type="text" class="form-control" name="{{form.th_sm_code.name}}" required
                                value="B001">
                           
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12 mt-5">
            <div>
                <div class="card-header text-center">
                    <h5 class="display-5">
                        Transaction Body
                    </h5>
                </div>
                <div class="card-body">
                    
                    <table class="customers">
                        <thead class="thead-light">
                            <tr>
                                <th>Code</th>
                                <th  class = "text-danger">Description</th>
                                <th>Quantity</th>
                                <th  class = "text-danger">Price</th>
                                <th class="text-success">Total Price</th>
                                <th  class = "text-warning">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books_list">
                            <tr>
                                <td>
                                    <input type="text" name="book_code" class="form-control book_code"
                                        placeholder="Book Code" required>
                                </td>
                                <td>
                                    <input type="text" name="book_name" class="form-control book_name"
                                        placeholder="Book Name" readonly>
                                </td>
                                <td>
                                    <input type="number" class="form-control quantity" name="quantity"
                                        placeholder="Quantity" required>
                                </td>
                                <td>                                    
                                    <input type="text" class="form-control org_price" placeholder="Price"
                                        value="0" readonly>
                                </td>
                                <td>
                                    <input type="hidden" class="org_price">
                                    <input type="text" class="form-control price" name="price" placeholder="Total Price"
                                        value="0" readonly>
                                </td>                                
                                <td>
                                    <div class="btn-group">
                                        <button type="button" id="btnadd" class="btn add_new_row" title="Add">
                                            <i class="fas fa-plus-square"></i>
                                        </button>
                                        <button type="button" class="btn delete_row" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>              
                                <td></td>
                                <td></td>                                 
                                <td class = "text-success">Total Quantity: <strong id="final_quantity">0</strong></td>
                                <td></td>                                                 
                                <td class = "text-success"> Total Price: <strong id="final_price">0</strong></td>
                            </tr>
                        </tfoot>
                    </table>                    
                </div>
                <div class="col-md-12 mb-5">
                    <div class="btn-group">
                        <a href=""  class="btn btn-info mr-2" >Cancel</a>
                    <input type="submit" class="btn btn-info mr-2" name="save_home" value="Hold"}
                        <input type="submit" class="btn btn-info submit_form" name="save_next" value="Save&Print">&nbsp;
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<script>
    function update_total(){
        quantity = $(document).find('.quantity')
        prices = $(document).find('.price')        
        total_price = 0
        total_quantity = 0
        quantity.each(function(){
            total_quantity = total_quantity + parseInt($(this).val())
        })
        prices.each(function(){
            total_price = total_price + parseFloat($(this).val())
        })                        
        $(document).find("#final_quantity").html(total_quantity)
        $(document).find("#final_price").html(total_price)
    }
    $(document).on("click", ".add_new_row", function () {
        tbody = $(document).find("#books_list")
        tr = tbody.find("tr")
        new_row = "<tr>" + tr.html() + "</tr>"
        tbody.append(new_row)
         $("tbody tr:last td:first input").focus();
    })
    $(document).on("click", ".delete_row", function () {
        $(this).parent().parent().parent().remove()
        update_total()
    })
    $(document).on("focusout", ".book_code", function () {
        var that = $(this)
        $.ajax({
            url: '{% url "get_book_details" %}',
            type: 'post',
            data: {
                'book_code': $(this).val(),
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success: function (response) {
                if (response.error){                    
                    alert(response.error)
                    that.val("")                    
                }
                else{
                that.closest('tr').find(".price").val(0)
                that.closest('tr').find(".org_price").val(response.price)
                that.closest('tr').find(".book_name").val(response.name)
                that.closest('tr').find(".quantity").val(0)
                update_total()
                }
            }
        })
    })
    $(document).on("focus",".quantity",function(){
        $(document).find(".submit_form").attr("disabled",true)

    })
    $(document).on("focusout", ".quantity", function () {
        org_price = parseFloat($(this).closest('tr').find(".org_price").val())
        quantity = parseInt($(this).val())
        that = $(this)
        $(this).closest('tr').find('.price').val(org_price * quantity)        
        $.ajax({
            url:"/check_book_quantity",
            type:"POST",
            data:{
                'quantity':$(this).val(),
                'book_code':$(this).closest('tr').find('.book_code').val(),
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success:function(response){
                if(response.error){
                    alert(response.error)
                    that.val(0)
                    that.closest('tr').find(".price").val(that.closest('tr').find(".org_price").val())
                    update_total()
                }
                else{
                    update_total()
                  
                    document.getElementById('btnadd').click();
                }
                $(document).find(".submit_form").attr("disabled",false)
            }
        })
    })    
    $(document).on("click",".submit_form",function(){
        quantity = $(document).find(".quantity")
        var book_codes = $(document).find(".book_code")        
        var books = []
        var flag=0
        quantity.each(function(){
            if($(this).val() <= 0){
                alert("Quantity cannot be negative or zero.")
                flag = 1
                return false;
            }
        })
        book_codes.each(function(){
            if(books){
                if(books.includes($(this).val())){
                    flag = 1
                    alert("Duplicate books are not allowed")
                }
                else{
                    books.push($(this).val())
                }
            }
            else{
                books.push($(this).val())
            }
        })
        if(flag==0){
            $("#new_trans_form").submit()
        }
        event.preventDefault()
    })
</script>
</div>
<script>
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
}

function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
}
</script>

<style>
.element1 {display:inline-block; width:35%; padding:10px}
.element2 {display:inline-block; width:55%; padding:10px}
</style>

</body>
</html>
